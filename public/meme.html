<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milady Type A</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #000000;
            color: #FFFFFF;
            line-height: 1.5;
        }

        a {
            color: #0000EE;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
        .nav-links {
    text-align: center;
    margin-bottom: 10px;
}
.nav-links a {
    margin: 0 15px;
    font-size: 16px;
    color: #0000EE;
    text-decoration: none;
}

.nav-links a:hover {
    text-decoration: underline;
    color: #FF0000;
}

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .top-logo {
            max-width: 300px;
        }

        main {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }

        .traits-panel {
            background-color: #0000EE;
            border: 1px solid #0000EE;
            padding: 10px;
            width: 35%; /* Adjusted from 35% to make space for wider panel if needed */
            min-width: 380px; /* Ensure panel is wide enough for controls */
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 80vh;
        }

        .traits-header {
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #FFFFFF;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #FFFFFF;
        }

        .random-btn {
            background-color: #000000;
            border: 1px solid #0000EE;
            color: #0000EE;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .random-btn:hover {
            background-color: #0000EE;
            color: #FFFFFF;
        }

        .trait {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px; /* Adjusted gap */
        }

        .trait label {
            width: 110px; /* Adjusted width */
            font-size: 14px;
            text-align: right;
            color: #FFFFFF;
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        .eye-toggle {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 0 5px;
    color: #FFFFFF; /* Default 'on' state color */
    line-height: 1;
    margin-left: 5px; /* Space after label */
    flex-shrink: 0;
}

.eye-toggle.hidden-layer {
    color: #888; /* 'Off' state color */
    /* Removed text-decoration: line-through; to avoid confusion with emoji */
}

        .trait-nav {
            flex: 1; /* Allow trait-nav to take remaining space */
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #000000;
            border: 1px solid #0000EE;
            padding: 5px;
            min-width: 180px; /* Adjusted min-width */
        }

        .trait-nav button {
            background: none;
            border: none;
            color: #0000EE;
            font-size: 16px;
            cursor: pointer;
        }

        .trait-nav button:hover {
            color: #FF0000;
        }

        .trait-name {
            flex: 1;
            text-align: center;
            font-size: 14px;
            color: #0000EE;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0 5px; /* Add some margin around the name */
        }

        .image-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .milady-image {
            background-color: #FFF;
            border: 1px solid #0000EE;
            padding: 10px;
            position: relative;
            width: 506px;
            max-width: 100%;
        }

        .milady-image canvas {
            display: block;
            width: 506px; /* Fixed width for canvas */
            height: 634px; /* Fixed height for canvas */
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            background: #F0E0D6;
            padding: 5px;
            border: 1px solid #0000EE;
        }

        .image-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 250px;
            background-color: #000000;
            border: 1px solid #0000EE;
            padding: 10px;
        }

        .image-controls input[type="text"] {
            padding: 10px;
            width: 200px;
            background-color: #000000;
            border: 1px solid #0000EE;
            font-size: 14px;
            text-align: center;
            color: #0000EE;
            text-transform: uppercase;
            font-weight: bold;
        }

        .image-controls input[type="text"]::placeholder {
            color: #0000EE;
            opacity: 0.7;
        }

        .font-size-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .font-size-control label {
            font-size: 14px;
            color: #0000EE;
        }

        .font-size-control input[type="range"] {
            width: 200px;
        }

        .glow-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .glow-control label {
            font-size: 14px;
            color: #0000EE;
        }

        .glow-control input[type="checkbox"] {
            width: 16px;
            height: 14px;
        }

        @media (max-width: 800px) {
            main {
                flex-direction: column;
                align-items: center;
            }

            .traits-panel,
            .image-panel {
                width: 100%;
                max-width: 100%;
                min-width: unset; /* Reset min-width for mobile */
            }
            
            .milady-image {
                width: 100%;
            }

            .milady-image canvas {
                width: 100%; /* Make canvas responsive */
                height: auto; /* Maintain aspect ratio */
            }

            .trait-nav {
                min-width: 150px;
            }

            .trait label {
                width: 100px; /* Adjust label width for smaller screens */
            }
            
            /* Mobile-specific download button styling */
            #download-btn {
                min-height: 44px; /* iOS minimum touch target */
                font-size: 18px; /* Larger text for mobile */
                padding: 12px 20px;
            }
        }
        
        /* Download button hover effect */
        #download-btn:hover {
            background-color: #0000EE !important;
            color: #FFFFFF !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="https://wapal.io/collection/milady-type-a" target="_blank">
            <img src="/assets/miladytype_a_logo.png" alt="Milady Type A Logo" class="top-logo" onerror="this.style.display='none'">
        </a>
    </div>
    <div class="nav-links">
    <a href="/">Website</a>
    <a href="https://wapal.io/collection/milady-type-a" target="_blank">Secondary</a>
    <a href="https://x.com/MiladyOnApt" target="_blank">X</a>
    <a href="/meme">Meme Generator</a>
    </div>
    <main>
        <div class="traits-panel">
            <div class="traits-header">
                <span>Assets</span>
                <button class="random-btn" onclick="randomizeTraits()">Random</button>
            </div>
            <div class="trait">
                <label>Background</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('bgs', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="bgs">
                    <button onclick="changeTrait('bgs', -1)">‚óÑ</button>
                    <span class="trait-name" id="bgs-name">None</span>
                    <button onclick="changeTrait('bgs', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Full Aura</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('full aura', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="full aura">
                    <button onclick="changeTrait('full aura', -1)">‚óÑ</button>
                    <span class="trait-name" id="full-aura-name">None</span>
                    <button onclick="changeTrait('full aura', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Behind Head</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('behind head', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="behind head">
                    <button onclick="changeTrait('behind head', -1)">‚óÑ</button>
                    <span class="trait-name" id="behind-head-name">None</span>
                    <button onclick="changeTrait('behind head', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Bun</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('bun', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="bun">
                    <button onclick="changeTrait('bun', -1)">‚óÑ</button>
                    <span class="trait-name" id="bun-name">None</span>
                    <button onclick="changeTrait('bun', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Body</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('body', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="body">
                    <button onclick="changeTrait('body', -1)">‚óÑ</button>
                    <span class="trait-name" id="body-name">None</span>
                    <button onclick="changeTrait('body', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Face Decoration</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('face decoration', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="face decoration">
                    <button onclick="changeTrait('face decoration', -1)">‚óÑ</button>
                    <span class="trait-name" id="face-decoration-name">None</span>
                    <button onclick="changeTrait('face decoration', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Blush</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('blush', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="blush">
                    <button onclick="changeTrait('blush', -1)">‚óÑ</button>
                    <span class="trait-name" id="blush-name">None</span>
                    <button onclick="changeTrait('blush', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Eyes</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('eyes', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="eyes">
                    <button onclick="changeTrait('eyes', -1)">‚óÑ</button>
                    <span class="trait-name" id="eyes-name">None</span>
                    <button onclick="changeTrait('eyes', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Glasses</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('glasses', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="glasses">
                    <button onclick="changeTrait('glasses', -1)">‚óÑ</button>
                    <span class="trait-name" id="glasses-name">None</span>
                    <button onclick="changeTrait('glasses', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Necklace</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('necklace', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="necklace">
                    <button onclick="changeTrait('necklace', -1)">‚óÑ</button>
                    <span class="trait-name" id="necklace-name">None</span>
                    <button onclick="changeTrait('necklace', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Clothing</label>
                <div class="trait-nav" data-layer="clothing">
                    <button onclick="changeTrait('clothing', -1)">‚óÑ</button>
                    <span class="trait-name" id="clothing-name">None</span>
                    <button onclick="changeTrait('clothing', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Pin</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('pin', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="pin">
                    <button onclick="changeTrait('pin', -1)">‚óÑ</button>
                    <span class="trait-name" id="pin-name">None</span>
                    <button onclick="changeTrait('pin', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Hair</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('hair', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="hair">
                    <button onclick="changeTrait('hair', -1)">‚óÑ</button>
                    <span class="trait-name" id="hair-name">None</span>
                    <button onclick="changeTrait('hair', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Earring</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('earring', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="earring">
                    <button onclick="changeTrait('earring', -1)">‚óÑ</button>
                    <span class="trait-name" id="earring-name">None</span>
                    <button onclick="changeTrait('earring', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Head</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('head', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="head">
                    <button onclick="changeTrait('head', -1)">‚óÑ</button>
                    <span class="trait-name" id="head-name">None</span>
                    <button onclick="changeTrait('head', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Eyebrows</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('eyebrows', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="eyebrows">
                    <button onclick="changeTrait('eyebrows', -1)">‚óÑ</button>
                    <span class="trait-name" id="eyebrows-name">None</span>
                    <button onclick="changeTrait('eyebrows', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Mouth</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('mouth', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="mouth">
                    <button onclick="changeTrait('mouth', -1)">‚óÑ</button>
                    <span class="trait-name" id="mouth-name">None</span>
                    <button onclick="changeTrait('mouth', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Half Aura</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('half aura', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="half aura">
                    <button onclick="changeTrait('half aura', -1)">‚óÑ</button>
                    <span class="trait-name" id="half-aura-name">None</span>
                    <button onclick="changeTrait('half aura', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Item</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('item', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="item">
                    <button onclick="changeTrait('item', -1)">‚óÑ</button>
                    <span class="trait-name" id="item-name">None</span>
                    <button onclick="changeTrait('item', 1)">‚ñ∫</button>
                </div>
            </div>
            <div class="trait">
                <label>Overlay</label>
                <button class="eye-toggle" onclick="toggleLayerVisibility('overlay', this)">üëÅÔ∏è</button>
                <div class="trait-nav" data-layer="overlay">
                    <button onclick="changeTrait('overlay', -1)">‚óÑ</button>
                    <span class="trait-name" id="overlay-name">None</span>
                    <button onclick="changeTrait('overlay', 1)">‚ñ∫</button>
                </div>
            </div>
        </div>

        <div class="image-panel">
            <div class="milady-image">
                <canvas id="character-canvas"></canvas>
                </div>
            <div class="image-controls">
                        <input type="text" id="top-text" placeholder="TOP TEXT" oninput="updateCharacterImage(); this.value = this.value.toUpperCase();">
        <input type="text" id="bottom-text" placeholder="BOTTOM TEXT" oninput="updateCharacterImage(); this.value = this.value.toUpperCase();">
                <div class="font-size-control">
                    <label id="font-size-label">Font Size: 50px</label>
                    <input type="range" id="font-size-slider" min="20" max="100" value="50" oninput="updateFontSize(this.value)">
                </div>
                <div class="glow-control">
                    <label for="glow-checkbox">Glow Text</label>
                    <input type="checkbox" id="glow-checkbox" onchange="updateGlow(this.checked)">
                </div>
                <button id="download-btn" onclick="downloadImage()" style="
                    background-color: #000000;
                    border: 1px solid #0000EE;
                    color: #0000EE;
                    padding: 10px 20px;
                    font-size: 16px;
                    cursor: pointer;
                    margin-top: 10px;
                    width: 100%;
                    max-width: 200px;
                ">Download Image</button>
            </div>
        </div>
    </main>

    <script>
        // Constants
        const CANVAS_WIDTH = 723;
        const CANVAS_HEIGHT = 904;
        const GATEWAYS = [
            'https://gateway.lighthouse.storage/ipfs/',  // Fastest - pinned
            'https://nftstorage.link/ipfs/',             // Fast - NFT.Storage
            'https://w3s.link/ipfs/',                    // Fast - Web3.Storage
            'https://ipfs.io/ipfs/'                      // Slower - public gateway
        ];
        const API_BASE = 'https://dweb.link/api/v0/ls?arg=';
        const FOLDER_CID = 'bafybeihzodcfp5bzd5b2gwlw47h3vpwbvv3t4px4ql6viggtnpv24x5bvi';
        const MAX_RETRIES = 2;
        const CATEGORIES = [
            'bgs', 'full aura', 'behind head', 'bun', 'body',
            'face decoration', 'blush', 'eyes', 'glasses', 'necklace',
            'clothing', 'pin', 'hair', 'earring', 'head',
            'eyebrows', 'mouth', 'half aura', 'item', 'overlay'
        ];
        const DRAWING_ORDER = [ 
            { layer: 'bgs' }, { layer: 'full aura' }, { layer: 'behind head' }, 
            { layer: 'bun' }, { layer: 'body' }, { layer: 'face decoration' }, 
            { layer: 'blush' }, { layer: 'eyes' }, { layer: 'glasses' }, 
            { layer: 'necklace' }, { layer: 'clothing' }, { layer: 'pin' }, 
            { layer: 'hair' }, { layer: 'earring' }, { layer: 'head' }, 
            { layer: 'eyebrows' }, { layer: 'mouth' }, { layer: 'Half aura' }, 
            { layer: 'item' }, { layer: 'overlay' }
        ];
        
        // **IMPORTANT**: Ensure these trait arrays are complete and match your original full dataset.
        // The following are restored based on the earlier version of the code.
        const BACKGROUND_TRAITS = [
            { name: 'Black Pyramids', path: 'bgs/Black pyramids.png' },
            { name: 'Bridge Scene', path: 'bgs/Bridge scene.png' },
            { name: 'C6', path: 'bgs/C6.png' },
            { name: 'Cherry Blossom', path: 'bgs/Cherry blossom.png' },
            { name: 'Eclipse', path: 'bgs/Eclipse.png' },
            { name: 'Girls Dead Monster', path: 'bgs/Girls dead monster.png' },
            { name: 'Gundamcar', path: 'bgs/Gundamcar.png' },
            { name: 'Halo 2', path: 'bgs/Halo 2.png' },
            { name: 'Han', path: 'bgs/Han.png' },
            { name: 'Hatsune', path: 'bgs/Hatsune.png' },
            { name: 'Honda', path: 'bgs/Honda.png' },
            { name: 'Hueco Mundo', path: 'bgs/Hueco mundo.png' },
            { name: 'Izumi Van', path: 'bgs/Izumi van.png' },
            { name: 'Jesus', path: 'bgs/Jesus.png' },
            { name: 'Lain', path: 'bgs/Lain.png' },
            { name: 'Paul Walker', path: 'bgs/Paul walker.png' },
            { name: 'Peachgini', path: 'bgs/Peachgini.png' },
            { name: 'Rei 2', path: 'bgs/Rei 2.png' },
            { name: 'Rei Van', path: 'bgs/Rei van.png' },
            { name: 'Rei', path: 'bgs/Rei.png' },
            { name: 'Riku And Sora', path: 'bgs/Riku and sora.png' },
            { name: 'Roadside', path: 'bgs/Roadside.png' },
            { name: 'Rukia Bonkai', path: 'bgs/Rukia bonkai.png' },
            { name: 'Silvia', path: 'bgs/Silvia.png' },
            { name: 'Streets', path: 'bgs/Streets.png' },
            { name: 'Tank', path: 'bgs/Tank.png' },
            { name: 'Train', path: 'bgs/Train.png' },
            { name: 'Twilight Town', path: 'bgs/Twilight town.png' },
            { name: 'Ugly Miku', path: 'bgs/Ugly miku.png' },
            { name: 'UwU', path: 'bgs/UwU.png' },
            { name: 'Uzi', path: 'bgs/Uzi.png' },
            { name: 'Viper', path: 'bgs/Viper.png' }
        ];
        const FULL_AURA_TRAITS = [
            { name: 'Apol Iridescent -resized', path: 'full aura/Apol iridescent -resized.png' },
            { name: 'Apol Pensive-resized', path: 'full aura/Apol pensive-resized.png' },
            { name: 'Braid Iridescent -resized', path: 'full aura/Braid iridescent -resized.png' },
            { name: 'Braid Purple-resized', path: 'full aura/Braid purple-resized.png' },
            { name: 'Dion Watermelon-resized', path: 'full aura/Dion watermelon-resized.png' },
            { name: 'Watermelon-resized', path: 'full aura/Watermelon-resized.png' },
            { name: 'Braid Grey-resized', path: 'full aura/Braid grey-resized.png' },
            { name: 'Dion Iridescent -resized', path: 'full aura/Dion iridescent -resized.png' },
            { name: 'Dion Somber-resized', path: 'full aura/Dion somber-resized.png' },
            { name: 'Dion Sweet-resized', path: 'full aura/Dion sweet-resized.png' },
            { name: 'Dion Terracotta-resized', path: 'full aura/Dion terracotta-resized.png' },
            { name: 'Dionysian Calm-resized', path: 'full aura/Dionysian calm-resized.png' },
            { name: 'Floating-resized', path: 'full aura/Floating-resized.png' },
            { name: 'Grey-resized', path: 'full aura/Grey-resized.png' },
            { name: 'Peachy-resized', path: 'full aura/Peachy-resized.png' },
            { name: 'Thinking-resized', path: 'full aura/Thinking-resized.png' },
            { name: 'Apol Indigo-resized', path: 'full aura/Apol indigo-resized.png' },
            { name: 'Apol Sleepy-resized', path: 'full aura/Apol sleepy-resized.png' },
            { name: 'Braid Copper-resized', path: 'full aura/Braid copper-resized.png' },
            { name: 'Dion Copper-resized', path: 'full aura/Dion copper-resized.png' },
            { name: 'Dion Floating-resized', path: 'full aura/Dion floating-resized.png' },
            { name: 'Dion Grey-resized', path: 'full aura/Dion grey-resized.png' },
            { name: 'Dion Indigo-resized', path: 'full aura/Dion indigo-resized.png' },
            { name: 'Dion Ketamine-resized', path: 'full aura/Dion ketamine-resized.png' },
            { name: 'Dion Sunny-resized', path: 'full aura/Dion sunny-resized.png' },
            { name: 'Eggy-resized', path: 'full aura/Eggy-resized.png' },
            { name: 'Sweet-resized', path: 'full aura/Sweet-resized.png' },
            { name: 'Apollonian Laptop-resized', path: 'full aura/apollonian_laptop-resized.png' },
            { name: 'Apollonian Limewire-resized', path: 'full aura/apollonian_limewire-resized.png' },
            { name: 'Apol Soft-resized', path: 'full aura/Apol soft-resized.png' },
            { name: 'Braid Dark-resized', path: 'full aura/Braid dark-resized.png' },
            { name: 'Braid Ketamine-resized', path: 'full aura/Braid ketamine-resized.png' },
            { name: 'Braid Sweet-resized', path: 'full aura/Braid sweet-resized.png' },
            { name: 'Bright-resized', path: 'full aura/Bright-resized.png' },
            { name: 'Dion Bright-resized', path: 'full aura/Dion bright-resized.png' },
            { name: 'Dion Dark-resized', path: 'full aura/Dion dark-resized.png' },
            { name: 'Dion Sleepy(1)-resized', path: 'full aura/Dion sleepy(1)-resized.png' },
            { name: 'Dion Sleepy-resized', path: 'full aura/Dion sleepy-resized.png' },
            { name: 'Dion Soft-resized', path: 'full aura/Dion soft-resized.png' },
            { name: 'Joy Division-resized', path: 'full aura/Joy division-resized.png' },
            { name: 'Soft-resized', path: 'full aura/Soft-resized.png' },
            { name: 'Tang-resized', path: 'full aura/Tang-resized.png' }
        ];
        const BEHIND_HEAD_TRAITS = [
            { name: 'Asuna scarf', path: 'behind head/asuna scarf.png' }, { name: 'Shelter', path: 'behind head/shelter.png' }
        ];
        const BUN_TRAITS = [
            { name: 'Bun 1', path: 'bun/bun1.png' }, { name: 'Bun 65', path: 'bun/bun65.png' },
            { name: 'Bun green 765', path: 'bun/bungreen765.png' }, { name: 'Panda buns', path: 'bun/pandabuns.png' },
            { name: 'Pink bun 65', path: 'bun/pinkbuyn65.png' }
        ];
        const BODY_TRAITS = [
            { name: 'Apricot', path: 'body/apricot.png' }, { name: 'Arcturian', path: 'body/arcturian.png' },
            { name: 'Brown', path: 'body/brown.png' }, { name: 'Brownie', path: 'body/brownie.png' },
            { name: 'Cherry', path: 'body/cherry.png' }, { name: 'Lemon', path: 'body/lemon.png' },
            { name: 'Metal', path: 'body/metal.png' }, { name: 'Orange', path: 'body/orange.png' },
            { name: 'Pink pastel', path: 'body/pinkpastel.png' }, { name: 'Shrek', path: 'body/shrek.png' },
            { name: 'Tartarian', path: 'body/tartarian.png' }, { name: 'Unicorn', path: 'body/unicorn.png' },
            { name: 'Vanilla', path: 'body/vanilla.png' }, { name: 'White', path: 'body/white.png' }
        ];
        const FACE_DECORATION_TRAITS = [
            { name: 'Apt cheek', path: 'face decoration/Apt cheek-resized.png' }, { name: 'Apt neck', path: 'face decoration/Apt neck-resized.png' },
            { name: 'Mononoke', path: 'face decoration/Mononoke-resized.png' }, { name: 'Naruto whiskers', path: 'face decoration/Naruto whiskers-resized.png' },
            { name: 'Sasha', path: 'face decoration/Sasha-resized.png' }, { name: 'Bandaid', path: 'face decoration/bandaid-resized.png' },
            { name: 'Bleach 1', path: 'face decoration/bleach1-resized.png' }, { name: 'Blood 1', path: 'face decoration/blood1-resized.png' },
            { name: 'Blue whisker', path: 'face decoration/bluewisker-resized.png' }, { name: 'Chrome 1', path: 'face decoration/chrome1-resized.png' },
            { name: 'Chrome 44', path: 'face decoration/chrome44-resized.png' }, { name: 'Dole sticker', path: 'face decoration/dolesticker-resized.png' },
            { name: 'Eren', path: 'face decoration/eren-resized.png' }, { name: 'Eren 2', path: 'face decoration/eren2-resized.png' },
            { name: 'Goul', path: 'face decoration/goul.png' }, { name: 'Love garra', path: 'face decoration/lovegarra-resized.png' },
            { name: 'Mark 2', path: 'face decoration/mark2-resized.png' }, { name: 'Mark 4', path: 'face decoration/mark4-resized.png' },
            { name: 'Mark 55', path: 'face decoration/mark55-resized.png' }, { name: 'Purple marks', path: 'face decoration/purplemarks-resized.png' },
            { name: 'Scar 1', path: 'face decoration/scar1-resized.png' }, { name: 'Scar 2', path: 'face decoration/scar2-resized.png' },
            { name: 'Scar 5', path: 'face decoration/scar5-resized.png' }, { name: 'Tattoo 1', path: 'face decoration/tattoo1-resized.png' },
            { name: 'Tattoo 2', path: 'face decoration/tattoo2-resized.png' }, { name: 'Tattoo 3', path: 'face decoration/tattoo3-resized.png' },
            { name: 'Tattoo 333', path: 'face decoration/tattoo333-resized.png' }, { name: 'Tattoo 4', path: 'face decoration/tattoo4-resized.png' },
            { name: 'Tattoo 6', path: 'face decoration/tattoo6-resized.png' }, { name: 'Whisker 1', path: 'face decoration/wisker1-resized.png' }
        ];
        const BLUSH_TRAITS = [
            { name: 'Eyebrow blush', path: 'blush/eyebrowblush.png' }, { name: 'Eyepatch', path: 'blush/eyepatch_-resized.png' },
            { name: 'Light pink blush', path: 'blush/lightpinkblush.png' }, { name: 'Pink blush', path: 'blush/pinkblush.png' },
            { name: 'Red circle blush', path: 'blush/redcircleblush.png' }
        ];
        const EYES_TRAITS = [
            { name: 'Alien 1', path: 'eyes/Alien(1)-resized.png' }, { name: 'Classic', path: 'eyes/Classic-resized.png' },
            { name: 'Closed', path: 'eyes/Closed-resized.png' }, { name: 'Crying 1', path: 'eyes/Crying(1)-resized.png' },
            { name: 'Crying', path: 'eyes/Crying-resized.png' }, { name: 'Heart Eyes', path: 'eyes/Heart Eyes-resized.png' },
            { name: 'Oracle', path: 'eyes/Oracle-resized.png' }, { name: 'Sleepy', path: 'eyes/Sleepy-resized.png' },
            { name: 'Smug', path: 'eyes/Smug-resized.png' }, { name: 'Teary', path: 'eyes/Teary-resized.png' },
            { name: 'Alien', path: 'eyes/alien-resized.png' }, { name: 'Aqua 2', path: 'eyes/aqua2-resized.png' },
            { name: 'Aqua 3', path: 'eyes/aqua3-resized.png' }, { name: 'Aqua hearts', path: 'eyes/aquahearts-resized.png' },
            { name: 'Blue green 2', path: 'eyes/bluegreeen2-resized.png' }, { name: 'Blue hearts', path: 'eyes/bluehearts-resized.png' },
            { name: 'Blue red', path: 'eyes/bluered-resized.png' }, { name: 'Brown 2', path: 'eyes/brown2-resized.png' },
            { name: 'Brown eyes 44', path: 'eyes/browneyes44-resized.png' }, { name: 'Brush eyes', path: 'eyes/brusheyes-resized.png' },
            { name: 'Chinese', path: 'eyes/chinese-resized.png' }, { name: 'Chocolate', path: 'eyes/chocolate-resized.png' },
            { name: 'Dark blue 1', path: 'eyes/darkblue1-resized.png' }, { name: 'Green 2', path: 'eyes/green2-resized.png' },
            { name: 'Green 44', path: 'eyes/green44-resized.png' }, { name: 'Green brown', path: 'eyes/greenbrown-resized.png' },
            { name: 'Green eyes 1', path: 'eyes/greeneyes1-resized.png' }, { name: 'Kakashi', path: 'eyes/kakashi-resized.png' },
            { name: 'Light brown', path: 'eyes/lightbrown-resized.png' }, { name: 'Light green 2', path: 'eyes/lightgreen2-resized.png' },
            { name: 'Madara', path: 'eyes/madara-resized.png' }, { name: 'No eyes', path: 'eyes/noeyes-resized.png' },
            { name: 'No eyes 2', path: 'eyes/noeyes2-resized.png' }, { name: 'Obito', path: 'eyes/obito-resized.png' },
            { name: 'One eyed', path: 'eyes/oneeyed-resized.png' }, { name: 'Pink eyed', path: 'eyes/pinkeyed-resized.png' },
            { name: 'Pink hearts 2', path: 'eyes/pinkhearts2-resized.png' }, { name: 'Purple 2', path: 'eyes/purple2-resized.png' },
            { name: 'Rainbow 2', path: 'eyes/rainbow2-resized.png' }, { name: 'Red eyes', path: 'eyes/redeyes-resized.png' },
            { name: 'Retart', path: 'eyes/retart-resized.png' }, { name: 'Rinnegan', path: 'eyes/rinnegan-resized.png' },
            { name: 'Sasuke', path: 'eyes/sasuke-resized.png' }, { name: 'Solar', path: 'eyes/solar-resized.png' },
            { name: 'Star eyes', path: 'eyes/stareyes-resized.png' }, { name: 'Unicorn', path: 'eyes/unicorn-resized.png' },
            { name: 'UwU', path: 'eyes/uwu-resized.png' }, { name: 'Yellow green', path: 'eyes/yellowgreen-resized.png' },
            { name: 'Yellow pink 1', path: 'eyes/yellowpink1-resized.png' }
        ];
        const GLASSES_TRAITS = [
            { name: 'Cobain aptos', path: 'glasses/Cobain aptos-resized.png' }, { name: 'Eyes Glasses Round', path: 'glasses/Eyes-Glasses Round-resized.png' },
            { name: 'Eyes Glasses Orange Harajuku', path: 'glasses/Eyes-Glasses-Orange-Harajuku-resized.png' }, { name: 'Glasses Prescription Frames', path: 'glasses/Glasses-Perscription-Frames-resized.png' },
            { name: 'Larry Glasses', path: 'glasses/Larry Glasses-resized.png' }, { name: 'Rize', path: 'glasses/Rize-resized.png' },
            { name: 'White cobain aptos', path: 'glasses/White cobain aptos-resized.png' }, { name: 'YY Glasses', path: 'glasses/YY Glasses-resized.png' }
        ];
        const NECKLACE_TRAITS = [
            { name: 'Apt globe', path: 'necklace/Apt globe-resized.png' }, { name: 'Bear', path: 'necklace/Bear-resized.png' },
            { name: 'Cash', path: 'necklace/Cash-resized.png' }, { name: 'Cherry', path: 'necklace/Cherry-resized.png' },
            { name: 'Cross', path: 'necklace/Cross-resized.png' }, { name: 'Diamond', path: 'necklace/Diamond-resized.png' },
            { name: 'Flower of life', path: 'necklace/Flower of life-resized.png' }, { name: 'Kitty', path: 'necklace/Kitty-resized.png' },
            { name: 'Misa', path: 'necklace/Misa-resized.png' }, { name: 'Naruto', path: 'necklace/Naruto-resized.png' },
            { name: 'Neck Evil eye', path: 'necklace/Neck-Evil-eye-resized.png' }, { name: 'Orb', path: 'necklace/Orb-resized.png' },
            { name: 'Phone', path: 'necklace/Phone-resized.png' }, { name: 'Star', path: 'necklace/Star-resized.png' },
            { name: 'Sword', path: 'necklace/Sword-resized.png' }, { name: 'Beetle', path: 'necklace/beetle.png' },
            { name: 'Cheese necklace', path: 'necklace/cheese necklace.png' }, { name: 'Dororo', path: 'necklace/dororo-resized.png' }
        ];
        const CLOTHING_TRAITS = [
            { name: 'Anteiku uniform', path: 'clothing/Anteiku%20uniform.png' }, { name: 'Anya dress', path: 'clothing/Anya%20dress.png' },
            { name: 'Aptos White Shirt', path: 'clothing/Aptos%20White%20Shirt-resized.png' }, { name: 'Avery sweater', path: 'clothing/Avery%20sweater.png' },
            { name: 'Buzz', path: 'clothing/Buzz-resized.png' }, { name: 'Dolores', path: 'clothing/Dolores.png' },
            { name: 'Food Not Pharma short sleeve', path: 'clothing/Food%20Not%20Pharma%20-%20short%20sleeve-resized.png' }, { name: 'Mape hoodie', path: 'clothing/Mape%20hoodie.png' },
            { name: 'Random Black Robes', path: 'clothing/Random%20Black%20Robes-resized.png' }, { name: 'Senna', path: 'clothing/Senna.png' },
            { name: 'UA uniform', path: 'clothing/UA%20uniform.png' }, { name: 'White dress', path: 'clothing/White%20dress.png' },
            { name: 'Aqua', path: 'clothing/aqua-resized.png' }, { name: 'Autism shirt', path: 'clothing/autismshirt-resized.png' },
            { name: 'Black princess 1', path: 'clothing/blackprincess1-resized.png' }, { name: 'Black shirt 1', path: 'clothing/blackshirt1-resized.png' },
            { name: 'Blazer', path: 'clothing/blazer.png' }, { name: 'Bleach uniform', path: 'clothing/bleach%20uniform.png' },
            { name: 'Bosozuku', path: 'clothing/bosozuku.png' }, { name: 'Corbin', path: 'clothing/corbin-resized.png' },
            { name: 'Cortana', path: 'clothing/cortana-resized.png' }, { name: 'Covid', path: 'clothing/covid-resized.png' },
            { name: 'Evangalion', path: 'clothing/evangalion-resized.png' }, { name: 'Garagura', path: 'clothing/garagura-resized.png' },
            { name: 'Goth lolita', path: 'clothing/goth%20lolita.png' }, { name: 'Green flannel', path: 'clothing/green%20flannel.png' },
            { name: 'Griffith', path: 'clothing/griffith.png' }, { name: 'Hammer shirt', path: 'clothing/hammershirt-resized.png' },
            { name: 'Hikki tee', path: 'clothing/hikki%20tee.png' }, { name: 'Judge Judy', path: 'clothing/judgejudy-resized.png' },
            { name: 'Miad 1', path: 'clothing/miad1-resized.png' }, { name: 'Princess 1', path: 'clothing/princess1-resized.png' },
            { name: 'Princess pink 5', path: 'clothing/princesspink5-resized.png' }, { name: 'Rocket 1', path: 'clothing/rocket1-resized.png' },
            { name: 'Sailor', path: 'clothing/sailor-resized.png' }, { name: 'Sorayama', path: 'clothing/sorayama.png' },
            { name: 'Sweater', path: 'clothing/sweater.png' }, { name: 'Type A jacket', path: 'clothing/typeajacket-resized.png' },
            { name: 'Ukraine', path: 'clothing/ukraine-resized.png' }, { name: 'Vaccine', path: 'clothing/vaccine-resized.png' },
            { name: 'Violet Evergarden', path: 'clothing/violet%20evrgarden.png' }, { name: 'White shirt 11', path: 'clothing/whiteshirt11-resized.png' },
            { name: 'White shirt 5', path: 'clothing/whiteshirt5-resized.png' }, { name: 'White tank', path: 'clothing/whitetank-resized.png' },
            { name: 'White tank 2', path: 'clothing/whitetank2-resized.png' }, { name: 'White tank 3', path: 'clothing/whitetank3-resized.png' },
            { name: 'Yeezy 1', path: 'clothing/yeezy1-resized.png' }
        ];
        const PIN_TRAITS = [
            { name: 'Aptos pin', path: 'pin/Aptos%20pin-resized.png' }, { name: 'Holopin', path: 'pin/holopin-resized.png' }
        ];
        const HAIR_TRAITS = [
            { name: 'Aqua Blue 1', path: 'hair/aquablue1-resized.png' },
            { name: 'Auburn', path: 'hair/auburn-resized.png' },
            { name: 'Auburn 2233', path: 'hair/auburn2233-resized.png' },
            { name: 'Bang Pink', path: 'hair/bangpink-resized.png' },
            { name: 'Bang Red', path: 'hair/bangred-resized.png' },
            { name: 'Bangs Blue 11', path: 'hair/bangsblue11-resized.png' },
            { name: 'Black 65', path: 'hair/black65-resized.png' },
            { name: 'Black Long', path: 'hair/blacklong-resized.png' },
            { name: 'Braid Black', path: 'hair/braid black.png' },
            { name: 'Braid Chocolate', path: 'hair/braid choco late.png' },
            { name: 'Braid Corn', path: 'hair/braid corn.png' },
            { name: 'Braid Creme', path: 'hair/braid creme.png' },
            { name: 'Braid Green', path: 'hair/braid green.png' },
            { name: 'Braid Mold', path: 'hair/braid mold.png' },
            { name: 'Braid Pink', path: 'hair/braid pink.png' },
            { name: 'Braid Purple', path: 'hair/braid purple.png' },
            { name: 'Braid Teal', path: 'hair/braid teal.png' },
            { name: 'Braid White', path: 'hair/braid white.png' },
            { name: 'Brown 55', path: 'hair/brown55-resized.png' },
            { name: 'Brown 65', path: 'hair/brown65-resized.png' },
            { name: 'Brown Long', path: 'hair/brownlong-resized.png' },
            { name: 'Brown Short 22', path: 'hair/brownshort22-resized.png' },
            { name: 'Corn 33', path: 'hair/corn33-resized.png' },
            { name: 'Corn 34', path: 'hair/corn34-resized.png' },
            { name: 'Corn 44', path: 'hair/corn44-resized.png' },
            { name: 'Cortana Blue', path: 'hair/cortanablue-resized.png' },
            { name: 'Creme 2', path: 'hair/creme2-resized.png' },
            { name: 'Dark 11', path: 'hair/dark11-resized.png' },
            { name: 'Dark 65', path: 'hair/dark65-resized.png' },
            { name: 'Dark Black 65', path: 'hair/darkblack65-resized.png' },
            { name: 'Dark Blue 65', path: 'hair/darkblue65-resized.png' },
            { name: 'Dark Brown', path: 'hair/darkbrown-resized.png' },
            { name: 'Dark Dark 22', path: 'hair/darkdark22-resized.png' },
            { name: 'Dark Pink 65', path: 'hair/darkpink65-resized.png' },
            { name: 'Eto', path: 'hair/eto-resized.png' },
            { name: 'Fixed Pink 1122', path: 'hair/fixedpink1122-resized.png' },
            { name: 'Fuzzy Red', path: 'hair/fuzzyred-resized.png' },
            { name: 'Gargura', path: 'hair/gargura-resized.png' },
            { name: 'Green', path: 'hair/green-resized.png' },
            { name: 'Green 1165', path: 'hair/green1165-resized.png' },
            { name: 'Green 4', path: 'hair/green4-resized.png' },
            { name: 'Green 5', path: 'hair/green5-resized.png' },
            { name: 'Green Bang 11', path: 'hair/greenbang11-resized.png' },
            { name: 'Gren 1122', path: 'hair/gren1122-resized.png' },
            { name: 'Grey 65', path: 'hair/grey65-resized.png' },
            { name: 'Honda', path: 'hair/honda-resized.png' },
            { name: 'Light Blue', path: 'hair/lightblue-resized.png' },
            { name: 'Light Blue 22113', path: 'hair/lightblue22113-resized.png' },
            { name: 'Light Brown', path: 'hair/lightbrown-resized.png' },
            { name: 'Long Black 1122', path: 'hair/longblack1122-resized.png' },
            { name: 'Long Black 1212', path: 'hair/longblack1212-resized.png' },
            { name: 'Long Brown 1', path: 'hair/longbrown1-resized.png' },
            { name: 'Medium Green', path: 'hair/mediumgreen-resized.png' },
            { name: 'Mel Mel', path: 'hair/melmel-resized.png' },
            { name: 'Messy Green', path: 'hair/messygreen-resized.png' },
            { name: 'Midnight 65', path: 'hair/midnight65-resized.png' },
            { name: 'Mix Red', path: 'hair/mixred-resized.png' },
            { name: 'Naruto', path: 'hair/naruto-resized.png' },
            { name: 'Navy 55', path: 'hair/navy55-resized.png' },
            { name: 'Navy Blue 11', path: 'hair/navyblue11-resized.png' },
            { name: 'Off White', path: 'hair/offwhite-resized.png' },
            { name: 'Off White 2', path: 'hair/offwhite2-resized.png' },
            { name: 'Off White 22', path: 'hair/offwhite22-resized.png' },
            { name: 'Off White 33', path: 'hair/offwhite33-resized.png' },
            { name: 'Pink 22', path: 'hair/pink22-resized.png' },
            { name: 'Pink Short 1212', path: 'hair/pinkshort1212-resized.png' },
            { name: 'Purple 55', path: 'hair/purple55-resized.png' },
            { name: 'Purple 65', path: 'hair/purple65-resized.png' },
            { name: 'Rainbow 11', path: 'hair/rainbow11-resized.png' },
            { name: 'Rainbow 3322', path: 'hair/rainbow3322-resized.png' },
            { name: 'Red 5', path: 'hair/red5-resized.png' },
            { name: 'Red 65', path: 'hair/red65-resized.png' },
            { name: 'Rose 65', path: 'hair/rose65-resized.png' },
            { name: 'Seto Green', path: 'hair/setogreen-resized.png' },
            { name: 'Short Black', path: 'hair/shortblack-resized.png' },
            { name: 'Short Black 11', path: 'hair/shortblack11-resized.png' },
            { name: 'Short Blue 11', path: 'hair/shortblue11-resized.png' },
            { name: 'Short Brown 5544', path: 'hair/shortbrown5544-resized.png' },
            { name: 'Short Dark Black Brown', path: 'hair/shortdarkbalckbriown-resized.png' },
            { name: 'Short Grey 11', path: 'hair/shortgrey11-resized.png' },
            { name: 'Short Pink', path: 'hair/shortpink-resized.png' },
            { name: 'Short Purple', path: 'hair/shortpurple-resized.png' },
            { name: 'Short Red', path: 'hair/shortred-resized.png' },
            { name: 'Short White 1', path: 'hair/shortwhite1-resized.png' },
            { name: 'Short Yellow 1', path: 'hair/shortyello1-resized.png' },
            { name: 'Short Yellow 112233', path: 'hair/shortyello112233-resized.png' },
            { name: 'Silver 65', path: 'hair/silver65-resized.png' },
            { name: 'Teal 65', path: 'hair/teal65-resized.png' },
            { name: 'White', path: 'hair/white-resized.png' },
            { name: 'White 2', path: 'hair/white2-resized.png' },
            { name: 'White 3', path: 'hair/white3-resized.png' },
            { name: 'White 55', path: 'hair/white55-resized.png' },
            { name: 'White 65', path: 'hair/white65-resized.png' },
            { name: 'Yellow', path: 'hair/yellow-resized.png' },
            { name: 'Yellow 112222', path: 'hair/yellow112222-resized.png' },
            { name: 'Yellow 2', path: 'hair/yellow2-resized.png' },
            { name: 'Yellow 2233', path: 'hair/yellow2233-resized.png' },
            { name: 'Yellow 65', path: 'hair/yellow65-resized.png' }
        ];
        const EARRING_TRAITS = [
            { name: 'Aptos cross', path: 'earring/aptoscross.png' }, { name: 'Aptos dangle', path: 'earring/aptosdangle.png' },
            { name: 'Aptos stud', path: 'earring/aptosstud.png' }, { name: 'Bow', path: 'earring/bow.png' },
            { name: 'Cross emoji', path: 'earring/crossemoji.png' }, { name: 'Floppy', path: 'earring/floppy.png' },
            { name: 'Headphones', path: 'earring/headphones.png' }, { name: 'Mouse', path: 'earring/mouse.png' },
            { name: 'Pancakes', path: 'earring/pancakes.png' }
        ];
        const HEAD_TRAITS = [
            { name: 'Cake Hat', path: 'head/Cake Hat.png' }, { name: 'FEBB28EB', path: 'head/FEBB28EB-9421-4E7B-9ECA-66CBF3A7A4F8-resized.png' },
            { name: 'MWO', path: 'head/MWO-resized.png' }, { name: 'MWO2', path: 'head/MWO2-resized.png' },
            { name: 'Anya', path: 'head/anya-resized.png' }, { name: 'Apple head', path: 'head/applehead-resized.png' },
            { name: 'Aptos pin', path: 'head/aptospin-resized.png' }, { name: 'Ashibie', path: 'head/ashibie-resized.png' },
            { name: 'Aura hat', path: 'head/aurahat-resized.png' }, { name: 'Bass pro hat', path: 'head/bassprohat-resized.png' },
            { name: 'Brain zone', path: 'head/brainzone-resized.png' }, { name: 'Cat ears', path: 'head/catears-resized.png' },
            { name: 'Crown 1', path: 'head/crown1-resized.png' }, { name: 'Dole sticker', path: 'head/dolesticker-resized.png' },
            { name: 'Fujimoto', path: 'head/fujimoto-resized.png' }, { name: 'Hair tibbet', path: 'head/hairtibbet-resized.png' },
            { name: 'Haku', path: 'head/haku-resized.png' }, { name: 'Hinami', path: 'head/hinami-resized.png' },
            { name: 'Lettuce', path: 'head/lettuce-resized.png' }, { name: 'McGriddle', path: 'head/mcgriddle-resized.png' },
            { name: 'One eye', path: 'head/oneeye-resized.png' }, { name: 'Pink hair row', path: 'head/pinkhairrow-resized.png' },
            { name: 'Pink hat 11', path: 'head/pinkhat11-resized.png' }, { name: 'Pink horns', path: 'head/pinkhorns-resized.png' },
            { name: 'Pink teeth', path: 'head/pinkteeth-resized.png' }, { name: 'Plant head', path: 'head/planthead-resized.png' },
            { name: 'Purple bar', path: 'head/purplebar-resized.png' }, { name: 'Radiation', path: 'head/radiation-resized.png' },
            { name: 'Retart puter', path: 'head/retart puter.png' }, { name: 'Ribbons', path: 'head/ribbons-resized.png' },
            { name: 'Shark', path: 'head/shark-resized.png' }, { name: 'Sharky', path: 'head/sharky.png' },
            { name: 'Slime', path: 'head/slime-resized.png' }, { name: 'Strawberry', path: 'head/strawberry-resized.png' },
            { name: 'Tech horns', path: 'head/techhorns-resized.png' }, { name: 'Toast', path: 'head/toast-resized.png' },
            { name: 'Toothless', path: 'head/toothless-resized.png' }, { name: 'Yahikko', path: 'head/yahikko-resized.png' }
        ];
        const EYEBROWS_TRAITS = [
            { name: 'Albanian', path: 'eyebrows/albanian-resized.png' }, { name: 'Alien', path: 'eyebrows/alien-resized.png' },
            { name: 'American', path: 'eyebrows/american-resized.png' }, { name: 'Asian', path: 'eyebrows/asian-resized.png' },
            { name: 'Indian', path: 'eyebrows/indian-resized.png' }, { name: 'Jewish', path: 'eyebrows/jewish-resized.png' },
            { name: 'Swordfish', path: 'eyebrows/swordfish-resized.png' }
        ];
        const MOUTH_TRAITS = [
            { name: '3', path: 'mouth/3-resized.png' }, { name: 'Cat', path: 'mouth/Cat-resized.png' },
            { name: 'Cigar', path: 'mouth/Cigar-resized.png' }, { name: 'Crooked', path: 'mouth/Crooked-resized.png' },
            { name: 'Elated', path: 'mouth/Elated-resized.png' }, { name: 'Fang', path: 'mouth/Fang-resized.png' },
            { name: 'Flat', path: 'mouth/Flat-resized.png' }, { name: 'Griffith', path: 'mouth/Griffith-resized.png' },
            { name: 'Half frown', path: 'mouth/Half frown-resized.png' }, { name: 'Hm', path: 'mouth/Hm-resized.png' },
            { name: 'Pout', path: 'mouth/Pout-resized.png' }, { name: 'Smile', path: 'mouth/Smile-resized.png' },
            { name: 'Smile B', path: 'mouth/SmileB-resized.png' }, { name: 'Smile C', path: 'mouth/SmileC-resized.png' },
            { name: 'Smug', path: 'mouth/Smug-resized.png' }, { name: 'Teeth', path: 'mouth/Teeth-resized.png' },
            { name: 'Tohru', path: 'mouth/Tohru-resized.png' }, { name: 'Vamp', path: 'mouth/Vamp-resized.png' }
        ];
        const HALF_AURA_TRAITS = [
            { name: 'Blue', path: 'Half aura/blue.PNG' },
            { name: 'Green', path: 'Half aura/green.PNG' },
            { name: 'Orange', path: 'Half aura/orange.PNG' },
            { name: 'Pink', path: 'Half aura/pink.PNG' },
            { name: 'Purple', path: 'Half aura/purple.PNG' },
            { name: 'Rainbow 1', path: 'Half aura/rainbow1.PNG' },
            { name: 'Rainbow 2', path: 'Half aura/rainbow2.PNG' },
            { name: 'Yellow', path: 'Half aura/yellow.PNG' }
        ];
        const ITEM_TRAITS = [
            { name: 'Aqua keyblade', path: 'item/Aqua keyblade-resized.png' }, { name: 'Bankai', path: 'item/Bankai-resized.png' },
            { name: 'Cartman', path: 'item/Cartman-resized.png' }, { name: 'Cereal', path: 'item/Cereal-resized.png' },
            { name: 'Cheeseborgor', path: 'item/Cheeseborgor-resized.png' }, { name: 'Cig', path: 'item/Cig-resized.png' },
            { name: 'Death note', path: 'item/Death note-resized.png' }, { name: 'Final fantasy', path: 'item/Final fantasy-resized.png' },
            { name: 'Glep', path: 'item/Glep-resized.png' }, { name: 'Kirito', path: 'item/Kirito-resized.png' },
            { name: 'Kittykaki', path: 'item/Kittykaki-resized.png' }, { name: 'Leek', path: 'item/Leek-resized.png' },
            { name: 'Light sword', path: 'item/light-resized.png' }, { name: 'Lily', path: 'item/Lily-resized.png' },
            { name: 'Milady Fumo', path: 'item/Milady Fumo-resized.png' }, { name: 'OC hammer', path: 'item/OC hammer-resized.png' },
            { name: 'Pak-9', path: 'item/Pak-9-resized.png' }, { name: 'Remilia', path: 'item/remilia-resized.png' },
            { name: 'Shishi', path: 'item/Shishi-resized.png' }, { name: 'Spacekitty', path: 'item/Spacekitty-resized.png' },
            { name: 'Spoon', path: 'item/spoon-resized.png' }, { name: 'Ilawbu', path: 'item/ilaw-resized.png' }
        ];
        const OVERLAY_TRAITS = [
            { name: 'Bees', path: 'overlay/Bees-resized.png' }, { name: 'Jesus Fish', path: 'overlay/Jesus fish-resized.png' },
            { name: 'Sparkles', path: 'overlay/Sparkles-resized.png' },
        ];


        // State
        const state = {
            fontSize: 50,
            glowEnabled: false,
            traitLists: {},
            currentIndices: Object.fromEntries(CATEGORIES.map(category => [category, 0])),
            layerVisibility: Object.fromEntries(CATEGORIES.map(category => [category, true])),
            imageCache: new Map(),
            cacheHits: 0,
            cacheMisses: 0
        };
        
        // Cache management
        const MAX_CACHE_SIZE = 200; // Limit cache to prevent memory issues
        
        function manageCache() {
            if (state.imageCache.size > MAX_CACHE_SIZE) {
                // Remove oldest entries (first 50 entries)
                const entriesToRemove = Array.from(state.imageCache.keys()).slice(0, 50);
                entriesToRemove.forEach(key => state.imageCache.delete(key));
                logInfo(`Cache cleaned: removed ${entriesToRemove.length} entries`);
            }
        }

        // DOM Elements
        const elements = {
            topTextInput: document.getElementById('top-text'),
            bottomTextInput: document.getElementById('bottom-text'),
            fontSizeSlider: document.getElementById('font-size-slider'),
            fontSizeLabel: document.getElementById('font-size-label'),
            glowCheckbox: document.getElementById('glow-checkbox'),
            canvas: document.getElementById('character-canvas')
        };

        // Canvas Setup
        elements.canvas.width = CANVAS_WIDTH;
        elements.canvas.height = CANVAS_HEIGHT;
        const ctx = elements.canvas.getContext('2d');
        logInfo(`Canvas initialized with size ${CANVAS_WIDTH}x${CANVAS_HEIGHT}`);

        // Utility Functions
        function showLoading() {
            const existing = document.querySelector('.loading');
            if (existing) existing.remove();
            const loadingText = document.createElement('div');
            loadingText.className = 'loading';
            loadingText.textContent = 'Loading...';
            elements.canvas.parentElement.insertBefore(loadingText, elements.canvas);
        }

        function hideLoading() {
            const loadingText = document.querySelector('.loading');
            if (loadingText) loadingText.remove();
        }
        
        function logError(message, error) {
            console.error(`[${new Date().toISOString()}] ${message}`, error?.message || error);
        }

        function logInfo(message, data = '') {
            console.log(`[${new Date().toISOString()}] ${message}`, data);
        }
        
        // Populate Trait Lists
        async function populateTraitLists() {
            const filesByCategory = {
                'bgs': BACKGROUND_TRAITS,
                'full aura': FULL_AURA_TRAITS,
                'behind head': BEHIND_HEAD_TRAITS,
                'bun': BUN_TRAITS,
                'body': BODY_TRAITS,
                'face decoration': FACE_DECORATION_TRAITS,
                'blush': BLUSH_TRAITS,
                'eyes': EYES_TRAITS,
                'glasses': GLASSES_TRAITS,
                'necklace': NECKLACE_TRAITS,
                'clothing': CLOTHING_TRAITS, 
                'pin': PIN_TRAITS,
                'hair': HAIR_TRAITS,        
                'earring': EARRING_TRAITS,
                'head': HEAD_TRAITS,
                'eyebrows': EYEBROWS_TRAITS,
                'mouth': MOUTH_TRAITS,
                'half aura': HALF_AURA_TRAITS,
                'item': ITEM_TRAITS,
                'overlay': OVERLAY_TRAITS
            };

            CATEGORIES.forEach(category => {
                const files = filesByCategory[category] || [];
                // Ensure files are sorted by name for consistent order
                const sortedFiles = files.sort((a, b) => a.name.localeCompare(b.name));

                if (category === 'clothing' || category === 'hair') {
                    state.traitLists[category] = [...sortedFiles];
                    if (sortedFiles.length > 0) {
                        state.currentIndices[category] = 0;
                    } else {
                        state.currentIndices[category] = -1; 
                        logError(`Layer ${category} is empty. Ensure trait arrays are populated.`);
                    }
                } else {
                    state.traitLists[category] = [{ name: 'None', path: 'none' }, ...sortedFiles];
                    state.currentIndices[category] = 0; 
                }

                logInfo(`Populated ${category} with ${state.traitLists[category].length} traits. Initial index: ${state.currentIndices[category]}`);
                
                const nameElement = document.getElementById(`${category.toLowerCase().replace(/ /g, '-')}-name`);
                if (nameElement) {
                    if (state.traitLists[category].length > 0 && state.currentIndices[category] !== -1) {
                        const initialTrait = state.traitLists[category][state.currentIndices[category]];
                        nameElement.textContent = initialTrait ? initialTrait.name : 'N/A';
                    } else {
                        nameElement.textContent = 'Empty'; // Or 'N/A' if preferred for empty lists
                    }
                } else {
                    logError(`Element not found for trait name: ${category.toLowerCase().replace(/ /g, '-')}-name`);
                }
            });
            logInfo('Trait lists populated and initial names set.');
        }


        // Optimized Image Loading with Enhanced Caching and Priority Loading
        async function loadImage(url, traitName, retryCount = 0, gatewayIndex = 0, priority = 'normal') {
            if (state.imageCache.has(url)) {
                state.cacheHits++;
                logInfo(`Cache hit for ${traitName}: ${url} (Hits: ${state.cacheHits}, Misses: ${state.cacheMisses})`);
                return state.imageCache.get(url);
            }
            
            state.cacheMisses++;
            manageCache(); // Clean cache if needed

            if (gatewayIndex >= GATEWAYS.length) {
                throw new Error(`All gateways failed for ${traitName}`);
            }

            const gatewayUrl = `${GATEWAYS[gatewayIndex]}${FOLDER_CID}/${url}`;
            logInfo(`Attempting to load ${traitName} (retry ${retryCount}/${MAX_RETRIES}, gateway ${gatewayIndex + 1}/${GATEWAYS.length}): ${gatewayUrl}`);

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                
                // Optimize timeout based on priority
                const timeoutDuration = priority === 'high' ? 5000 : 8000; // Faster timeout for high priority
                const timeout = setTimeout(() => {
                    img.onerror();
                }, timeoutDuration);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    state.imageCache.set(url, img);
                    logInfo(`Loaded and cached ${traitName}: ${gatewayUrl}`);
                    resolve(img);
                };
                img.onerror = async () => {
                    clearTimeout(timeout);
                    logError(`Failed to load ${traitName}: ${gatewayUrl}`);
                    if (retryCount < MAX_RETRIES) {
                        try {
                            const retryImg = await loadImage(url, traitName, retryCount + 1, gatewayIndex, priority);
                            resolve(retryImg);
                        } catch (e) { reject(e); }
                    } else if (gatewayIndex < GATEWAYS.length - 1) {
                        try {
                            const nextGatewayImg = await loadImage(url, traitName, 0, gatewayIndex + 1, priority);
                            resolve(nextGatewayImg);
                        } catch (e) { reject(e); }
                    } else {
                        reject(new Error(`Failed to load ${traitName} after ${MAX_RETRIES} retries across all gateways`));
                    }
                };
                img.src = gatewayUrl;
            });
        }

        // Enhanced Preloading Strategy with Progressive Loading
        async function preloadCommonImages() {
            logInfo('Starting enhanced preload of common images...');
            
            // Phase 1: Load essential traits first (background, body, eyes, mouth)
            const essentialTraits = [
                ...BACKGROUND_TRAITS.slice(0, 2),
                ...BODY_TRAITS.slice(0, 2),
                ...EYES_TRAITS.slice(0, 2),
                ...MOUTH_TRAITS.slice(0, 2)
            ];

            const essentialPromises = essentialTraits.map(trait => 
                loadImage(trait.path, trait.name).catch(error => {
                    logError(`Essential preload failed for ${trait.name}`, error);
                    return null;
                })
            );

            try {
                await Promise.allSettled(essentialPromises);
                logInfo('Essential images preload completed');
                
                // Phase 2: Load popular hair styles in background
                const popularHairTraits = HAIR_TRAITS.slice(0, 10); // Load first 10 hair styles
                const hairPromises = popularHairTraits.map(trait => 
                    loadImage(trait.path, trait.name).catch(error => {
                        logError(`Hair preload failed for ${trait.name}`, error);
                        return null;
                    })
                );
                
                // Don't wait for hair to complete - let it load in background
                Promise.allSettled(hairPromises).then(() => {
                    logInfo('Popular hair styles preload completed');
                });
                
            } catch (error) {
                logError('Essential preload failed', error);
            }
        }

        // Render Text (Original function)
        function renderText() {
            const topText = elements.topTextInput.value.trim();
            const bottomText = elements.bottomTextInput.value.trim();
            if (!topText && !bottomText) return;

            ctx.font = `bold ${state.fontSize}px Impact`;
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 4; 
            ctx.textAlign = 'center';

            if (state.glowEnabled) {
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#0000FF'; 
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            const topTextY = state.fontSize + 20; 
            const bottomTextY = CANVAS_HEIGHT - 20; 

            if (topText) {
                logInfo('Drawing top text', topText);
                ctx.strokeText(topText, CANVAS_WIDTH / 2, topTextY); 
                ctx.fillText(topText, CANVAS_WIDTH / 2, topTextY);
            }
            if (bottomText) {
                logInfo('Drawing bottom text', bottomText);
                ctx.strokeText(bottomText, CANVAS_WIDTH / 2, bottomTextY); 
                ctx.fillText(bottomText, CANVAS_WIDTH / 2, bottomTextY);
            }
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }

        // Debounced canvas update to prevent excessive rendering
        let updateTimeout = null;
        
        // Optimized Canvas Update with Parallel Image Loading and Debouncing
        async function updateCharacterImage() {
            // Clear any pending update
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Debounce rapid changes (like fast clicking)
            updateTimeout = setTimeout(async () => {
                await performCanvasUpdate();
            }, 100); // 100ms debounce
        }
        
        async function performCanvasUpdate() {
            logInfo('Updating character image');
            if (!Object.keys(state.traitLists).length || CATEGORIES.some(cat => !state.traitLists[cat])) {
                logError('Trait lists not fully populated yet.');
                return;
            }
            
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            showLoading();

            // Collect all visible layers that need images
            const layersToLoad = DRAWING_ORDER.filter(({ layer }) => {
                if (!state.layerVisibility[layer] && layer !== 'clothing') {
                    logInfo(`Layer ${layer} is hidden, skipping.`);
                    return false;
                }

                const traitIndex = state.currentIndices[layer];
                const traitListForLayer = state.traitLists[layer];

                if (!traitListForLayer || traitListForLayer.length === 0) {
                    logError(`No trait list found or empty for layer: ${layer}`);
                    return false;
                }
                
                if (traitIndex === -1) {
                    logInfo(`Layer ${layer} has no valid selection (index is -1), skipping image load.`);
                    return false;
                }
                
                const trait = traitListForLayer[traitIndex];
                if (!trait) {
                    logError(`No trait found for ${layer} at index ${traitIndex}`);
                    return false;
                }

                if (trait.path === 'none') {
                    logInfo(`Layer ${layer} is set to 'None', skipping image load.`);
                    return false;
                }

                return true;
            });

            // Load all images in parallel with priority
            const imagePromises = layersToLoad.map(async ({ layer }) => {
                const traitIndex = state.currentIndices[layer];
                const traitListForLayer = state.traitLists[layer];
                const trait = traitListForLayer[traitIndex];
                
                logInfo(`Loading image for ${layer}: ${trait.name} from ${trait.path}`);
                
                try {
                    // Give priority to essential layers
                    const priority = ['bgs', 'body', 'eyes', 'mouth'].includes(layer) ? 'high' : 'normal';
                    const img = await loadImage(trait.path, trait.name, 0, 0, priority);
                    return { layer, img, trait };
                } catch (error) {
                    logError(`Failed to load image for ${layer}: ${trait.name}`, error);
                    return { layer, img: null, trait };
                }
            });

            try {
                const loadedImages = await Promise.all(imagePromises);
                
                // Draw images in correct order
                for (const { layer, img, trait } of loadedImages) {
                    if (img) {
                        ctx.drawImage(img, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                        logInfo(`Rendered ${trait.name} (layer: ${layer})`);
                    }
                }
                
                renderText();
                hideLoading();
                logInfo('Canvas update complete');
            } catch (error) {
                logError('Overall canvas update failed during layer processing', error);
                hideLoading();
                renderText();
            }
        }

        // Event Handlers
        window.updateFontSize = value => {
            state.fontSize = parseInt(value);
            elements.fontSizeLabel.textContent = `Font Size: ${state.fontSize}px`;
            logInfo(`Font size updated to ${state.fontSize}px`);
            updateCharacterImage();
        };

        window.updateGlow = checked => {
            state.glowEnabled = checked;
            logInfo(`Glow enabled: ${state.glowEnabled}`);
            updateCharacterImage();
        };

        window.changeTrait = (layer, direction) => {
            if (!state.traitLists[layer]) {
                logError(`Trait list for layer ${layer} not found.`);
                return;
            }
            const listLength = state.traitLists[layer].length;
            if (!listLength) { 
                logError(`No traits available for ${layer}`);
                return;
            }

            let newIndex = state.currentIndices[layer] + direction;
            newIndex = (newIndex % listLength + listLength) % listLength; 

            state.currentIndices[layer] = newIndex;
            const trait = state.traitLists[layer][newIndex];
            logInfo(`Changed ${layer} to ${trait.name} (index ${newIndex})`);
            
            const nameElement = document.getElementById(`${layer.toLowerCase().replace(/ /g, '-')}-name`);
            if (nameElement) {
                 nameElement.textContent = trait.name;
            } else {
                logError(`Element ID not found for trait name display: ${layer.toLowerCase().replace(/ /g, '-')}-name`);
            }
            
            // Update the character image immediately
            updateCharacterImage();
            
            // Preload adjacent traits in background for faster navigation
            preloadAdjacentTraits(layer, newIndex, listLength);
        };
        
        // Preload adjacent traits for faster navigation
        function preloadAdjacentTraits(layer, currentIndex, listLength) {
            const traitList = state.traitLists[layer];
            if (!traitList || traitList.length < 3) return;
            
            // Preload next and previous traits
            const nextIndex = (currentIndex + 1) % listLength;
            const prevIndex = (currentIndex - 1 + listLength) % listLength;
            
            const nextTrait = traitList[nextIndex];
            const prevTrait = traitList[prevIndex];
            
            if (nextTrait && nextTrait.path !== 'none') {
                loadImage(nextTrait.path, nextTrait.name, 0, 0, 'low').catch(() => {});
            }
            if (prevTrait && prevTrait.path !== 'none') {
                loadImage(prevTrait.path, prevTrait.name, 0, 0, 'low').catch(() => {});
            }
        }

        window.toggleLayerVisibility = (layerName, buttonElement) => {
    if (typeof state.layerVisibility[layerName] === 'undefined') {
        logError(`Visibility state for layer ${layerName} is undefined.`);
        state.layerVisibility[layerName] = true; 
    }
    state.layerVisibility[layerName] = !state.layerVisibility[layerName];
    logInfo(`Toggled visibility for ${layerName} to ${state.layerVisibility[layerName]}`);
    
    buttonElement.classList.toggle('hidden-layer', !state.layerVisibility[layerName]);
    buttonElement.textContent = state.layerVisibility[layerName] ? 'üëÅÔ∏è' : 'üö´';
    updateCharacterImage(); 
};

        window.randomizeTraits = () => {
            logInfo('Randomizing traits');
            // Check if all categories have trait lists and they are not empty
            const allEffectivelyPopulated = CATEGORIES.every(category => {
                const traitList = state.traitLists[category];
                return traitList && traitList.length > 0;
            });

            if (!allEffectivelyPopulated) {
                logError('Randomization failed: Some trait lists are effectively empty or not populated.');
                const statusDiv = document.getElementById('status-message'); 
                if (statusDiv) statusDiv.textContent = 'Cannot randomize: Assets loading or some categories are empty. Try again soon.';
                else console.warn('Status message element not found for user feedback.');
                return;
            }

            CATEGORIES.forEach(layer => {
                const listLength = state.traitLists[layer].length;
                // This check is now more robust due to the allEffectivelyPopulated check above.
                // if (listLength === 0) { 
                //     logInfo(`Layer ${layer} has no traits to randomize, skipping.`);
                //     return;
                // }
                const randomIndex = Math.floor(Math.random() * listLength);
                state.currentIndices[layer] = randomIndex;
                const trait = state.traitLists[layer][randomIndex];
                logInfo(`Randomized ${layer} to ${trait.name} (index ${randomIndex})`);
                const nameElement = document.getElementById(`${layer.toLowerCase().replace(/ /g, '-')}-name`);
                 if (nameElement) {
                    nameElement.textContent = trait.name;
                }
            });
            updateCharacterImage();
        };

        // Enhanced mobile save function with long-press support
        window.downloadImage = () => {
            const canvas = document.getElementById('character-canvas');
            if (!canvas) {
                logError('Canvas not found');
                return;
            }

            // Create a temporary canvas for high-quality download
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Set high resolution for better quality
            const scale = 2; // 2x resolution
            tempCanvas.width = CANVAS_WIDTH * scale;
            tempCanvas.height = CANVAS_HEIGHT * scale;
            
            // Scale the context for high resolution
            tempCtx.scale(scale, scale);
            
            // Draw the current canvas content
            tempCtx.drawImage(canvas, 0, 0);
            
            // Add text if present
            const topText = document.getElementById('top-text').value;
            const bottomText = document.getElementById('bottom-text').value;
            
            if (topText || bottomText) {
                tempCtx.scale(scale, scale); // Reset scale for text
                tempCtx.font = `${state.fontSize * scale}px Arial`;
                tempCtx.fillStyle = '#FFFFFF';
                tempCtx.strokeStyle = '#000000';
                tempCtx.lineWidth = 3 * scale;
                tempCtx.textAlign = 'center';
                
                if (topText) {
                    const y = 50 * scale;
                    if (state.glowEnabled) {
                        tempCtx.shadowColor = '#FFFF00';
                        tempCtx.shadowBlur = 10 * scale;
                    }
                    tempCtx.strokeText(topText, tempCanvas.width / 2, y);
                    tempCtx.fillText(topText, tempCanvas.width / 2, y);
                    tempCtx.shadowBlur = 0;
                }
                
                if (bottomText) {
                    const y = tempCanvas.height - 50 * scale;
                    if (state.glowEnabled) {
                        tempCtx.shadowColor = '#FFFF00';
                        tempCtx.shadowBlur = 10 * scale;
                    }
                    tempCtx.strokeText(bottomText, tempCanvas.width / 2, y);
                    tempCtx.fillText(bottomText, tempCanvas.width / 2, y);
                    tempCtx.shadowBlur = 0;
                }
            }
            
            // Convert to blob and handle download
            tempCanvas.toBlob((blob) => {
                if (!blob) {
                    logError('Failed to create image blob');
                    return;
                }
                
                // Check if mobile device
                if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    // Mobile approach: open image in new tab for native save/copy
                    const url = URL.createObjectURL(blob);
                    const newWindow = window.open(url, '_blank');
                    
                    if (newWindow) {
                        // Show simple instructions
                        setTimeout(() => {
                            alert('Image opened in new tab. Long press the image to save or copy it.');
                        }, 100);
                    } else {
                        // Fallback: create download link
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'milady-meme.png';
                        link.click();
                    }
                    
                    // Clean up
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);
                    
                    logInfo('Mobile image opened in new tab for native save/copy');
                } else {
                    // Desktop approach: direct download
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'milady-meme.png';
                    link.click();
                    
                    // Clean up
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);
                    
                    logInfo('Desktop download initiated');
                }
            }, 'image/png', 1.0);
        };



        // Setup uppercase text inputs
        function setupUppercaseInputs() {
            const topTextInput = document.getElementById('top-text');
            const bottomTextInput = document.getElementById('bottom-text');
            
            if (topTextInput) {
                topTextInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
            
            if (bottomTextInput) {
                bottomTextInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
            
            logInfo('Uppercase text inputs configured');
        }

        // Initialize
        async function initialize() {
    logInfo('Initializing character generator');
    showLoading(); 
    try {
        await populateTraitLists(); 
        logInfo('Trait lists populated');
        randomizeTraits(); // Call randomizeTraits to set random traits on load
        document.querySelectorAll('.eye-toggle').forEach(button => {
            const layerNavElement = button.nextElementSibling;
            if (layerNavElement && layerNavElement.classList.contains('trait-nav')) {
                const layerName = layerNavElement.getAttribute('data-layer'); 
                if (layerName && state.layerVisibility[layerName]) {
                    button.classList.remove('hidden-layer');
                } else if (layerName) {
                    button.classList.add('hidden-layer');
                }
            }
        });
        await updateCharacterImage(); 
        
        // Setup uppercase text inputs
        setupUppercaseInputs();
        
        // Start preloading common images in the background for faster subsequent loads
        preloadCommonImages().catch(error => {
            logError('Background preload failed', error);
        });
        
        logInfo('Initialization complete');
    } catch (error) {
        logError('Initialization failed', error);
    } finally {
        // hideLoading(); // Handled by updateCharacterImage or error block
    }
}

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
